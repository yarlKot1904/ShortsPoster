# ShortsPoster – курсовой проект

> *Telegram‑бот для публикации вертикальных видео (YouTube Shorts) прямо из чата*

---

## 1. Состав команды ¹

| Участник      | Группа | Роль в проекте     |
| ------------- | ------ | ------------------ |
| Павлов Е.С. | *5130904/20103* | backend |
| Лукьянов Р.С. | *5130904/20103* | DevOps & CI/CD     |
| Резк А.Ф. | *5130904/20103* | QA & тестирование  |
| Поляков А.Д. | *5130904/20103* | QA & тестирование  |

---

## 2. Определение проблемы

Создатели коротких вертикальных роликов часто публикуют контент в Telegram, а затем вынуждены вручную открывать YouTube Studio, загружать файл, заполнять метаданные и ждать окончания обработки.\
Процесс долгий, требует много кликов и нестабилен с мобильных устройств, поэтому мелкие авторы откладывают публикацию или вовсе отказываются от платформы — их ролики теряют актуальность и просмотры.

---

## 3. Выработка требований

### 3.1 Пользовательские истории (JTBD)

| ID  | История                                                                                                                                                                                       |
| --- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|  U1 | *Когда* я снял вертикальный ролик ≤ 60 с на телефон, *я хочу* переслать его боту и получить ссылку на уже опубликованный Short, *чтобы* сократить время от съёмки до публикации до 1–2 минут. |
|  U2 | *Когда* я публикую серию роликов с одной тематикой, *я хочу* повторно использовать последние теги, *чтобы* не вводить их каждый раз заново.                                                   |
|  U3 | *Когда* попытка загрузки закончилась ошибкой (quota, сеть), *я хочу* увидеть понятное сообщение в Telegram, *чтобы* оперативно исправить ситуацию.                                            |

### 3.2 Нефункциональные требования

- Время отклика Telegram‑бота — ≤ 500 мс на 95‑м перцентиле.
- Время ответа API YouTube — ≤ 5 с (ограничение внешнего сервиса).
- Доступность сервиса ≥ 99 %.
- Хранение метаданных ≥ 5 лет.

### 3.3 Оценка аудитории и данных

*Пиковая нагрузка*: **10 000** активных пользователей в сутки, до **60** запросов/мин в чате.\
*R/W распределение*: \~80 % чтение (получение сессий, последних тегов), 20 % запись (токены, новые ролики).\
*Дисковое хранилище*: 5 ГБ/год (PostgreSQL + логи), сами видео хранятся временно и удаляются после успешного аплоада.

---

## 4. Архитектура и проектирование

### 4.1 C4 Context

```
[User] → (Telegram) → [ShortsPoster Bot] → [YouTube Data API]
                                   ↓
                                [PostgreSQL]
```

- Пользователь общается через Telegram‑клиент.
- Бот (ASP.NET Core + Telegram.Bot) обрабатывает команды, управляет сессиями и загружает ролики через YouTube API.
- PostgreSQL хранит OAuth‑токены и последние теги.

### 4.2 C4 Container

| Container    | Технологии            | Ответственность                                                          |
| ------------ | --------------------- | ------------------------------------------------------------------------ |
| **Bot API**  | ASP.NET Core, Serilog | REST‑endpoints (`/oauth/callback`), long polling Telegram, бизнес‑логика |
| **DB**       | PostgreSQL 15         | Таблицы `usertokens`, `userlasttags`                                     |
| **External** | YouTube Data v3       | Загрузка видео, метаданные                                               |

### 4.3 Схема БД (DDL)

```sql
CREATE TABLE usertokens (
  id            SERIAL PRIMARY KEY,
  telegramuserid BIGINT NOT NULL UNIQUE,
  refreshtoken  TEXT   NOT NULL,
  createdat     TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE userlasttags (
  id            SERIAL PRIMARY KEY,
  telegramuserid BIGINT NOT NULL UNIQUE,
  tagscsv       TEXT   NOT NULL
);
```

\*Оба индекса по `telegramuserid` обеспечивают O(1) доступ при каждом запросе.

### 4.4 API контракты

| Method  | URL                     | Query/Body      | Response          | SLA      |
| ------- | ----------------------- | --------------- | ----------------- | -------- |
| **GET** | `/oauth/callback`       | `code`, `state` | `200 OK` + *HTML* | ≤ 500 мс |
| **BOT** | `/sendVideo` (Telegram) | MP4 file        | `Link`            |          |
| **BOT** | `/upload`               | –               | `Введите видео`   |          |

### 4.5 Масштабирование ×10

- **Bot API**: горизонтальное масштабирование (Docker Swarm / k8s, Stateless).
- **PostgreSQL**: master‑replica, pgbouncer, 3‑узловой Patroni‑кластер.
- **Cache**: Redis для сессий.

---

## 5. Кодирование и отладка

- Язык — C# 12 (.NET 8).
- Логирование — Serilog (`Information` → console, `Debug` → файл `Logs/`).
- Каждый участник имеет ≥ 5 мердж‑PR’ов; линтинг `dotnet format` в CI.

---

## 6. Тестирование

### 6.1 Unit

- `AppDbContextTests` — CRUD моделей.
- `YouTubePosterTests` — DI/конструктор.
- `ModelsTests` — корректность свойств.

### 6.2 Интеграционное

`ShortsPosterPipelineTests` воспроизводит сценарий U1: загрузка без авторизации → ожидаем `InvalidOperationException`.

---

## 7. Сборка и запуск

> Требования: **Docker 24 +, Bash**

```bash
# 1. Клонировать репозиторий
$ git clone https://github.com/<org>/ShortsPoster.git && cd ShortsPoster

#setup
  build
   docker compose run app dotnet ef database update
  migration
   docker compose run --rm migrator
#run
  docker compose up -d app
#tests
  docker build -f Dockerfile.tests -t shortsposter-tests .
  docker run --rm shortsposter-tests
```

CI — GitHub Actions: build, test, `docker buildx push` → Docker Hub.

---

## 8. Итоги

Проект **ShortsPoster** демонстрирует полный цикл создания ПО: *Problem → Требования → Архитектура → Код → Тесты → CI/CD* и удовлетворяет всем условиям курсового задания: БД + сервер + внешний API + UI.

